import React, { useState, useEffect, useMemo } from 'react';
import PropTypes from 'prop-types';
import { FiTrash2, FiEye, FiLoader, FiShare2 } from 'react-icons/fi';
import { FaBirthdayCake, FaPhone, FaHome, FaMale, FaFemale } from 'react-icons/fa';
import Swal from 'sweetalert2';
import { BlockButton } from './block/BlockButton';
import { BlockedBadge } from './block/BlockedBadge';
import { logger } from '../utils/logger';
import {
  buildDefaultFamilyPrivacySettings,
  getFamilyPrivacySettings,
  saveFamilyPrivacySettings,
} from '../utils/familyPrivacySettings';

const roleMapping = {
  1: 'Member',
  2: 'Admin',
  3: 'Superadmin',
};

const relationColors = {
  Member: 'bg-blue-100 text-blue-800',
  Admin: 'bg-purple-100 text-purple-800',
  Superadmin: 'bg-green-100 text-green-800',
};

const PRIVACY_VISIBILITY_OPTIONS = [
  { value: 'all-members', label: 'All Members (Except Blocked)' },
  { value: 'specific-family', label: 'Specific Family' },
];

const FamilyMemberCard = ({ familyCode, token, onViewMember, currentUser }) => {
  const [searchTerm, setSearchTerm] = useState('');
  const [familyMembers, setFamilyMembers] = useState([]);
  const [loading, setLoading] = useState(true);
  const [viewLoadingStates, setViewLoadingStates] = useState({});
  const [deletedMemberIds, setDeletedMemberIds] = useState(() => new Set());
  const [linkedFamilies, setLinkedFamilies] = useState([]);
  const [selectedAssociatedFamilyCode, setSelectedAssociatedFamilyCode] = useState('');
  const [selectedLinkedFamilyCode, setSelectedLinkedFamilyCode] = useState('');
  const [activeTab, setActiveTab] = useState('birth');
  const [membersNotInTree, setMembersNotInTree] = useState([]);
  const [memberIdsInTree, setMemberIdsInTree] = useState(() => new Set());
  const [treeLinkedFamilyMap, setTreeLinkedFamilyMap] = useState({});
  const [notInTreeLoading, setNotInTreeLoading] = useState(false);
  const [associatedFamilyNameMap, setAssociatedFamilyNameMap] = useState({});
  const [linkedFamilyNameMap, setLinkedFamilyNameMap] = useState({});
  const [privacySettings, setPrivacySettings] = useState(() =>
    buildDefaultFamilyPrivacySettings(''),
  );
  const [privacySavedAt, setPrivacySavedAt] = useState('');

  const BASE_URL = import.meta.env.VITE_API_BASE_URL;
  const normalizeFamilyCode = (code) => String(code || '').trim().toUpperCase();
  const birthFamilyCode = normalizeFamilyCode(familyCode);
  const currentUserFamilyCode = currentUser?.userProfile?.familyCode || currentUser?.familyCode;
  const currentUserIsFamilyAdmin =
    (currentUser?.role === 2 || currentUser?.role === 3) &&
    normalizeFamilyCode(currentUserFamilyCode) === normalizeFamilyCode(familyCode);

  const fetchMembers = async () => {
    try {
      const res = await fetch(`${BASE_URL}/family/member/${familyCode}`, {
        headers: {
          Authorization: `Bearer ${token}`,
        },
      });

      if (!res.ok) throw new Error('Failed to fetch members');
      const json = await res.json().catch(() => null);
      const list = Array.isArray(json?.data) ? json.data : [];
      const members = list.map((item) => ({
        id: item.id,
        memberId: item.memberId,
        userId: item.user?.id,
        membershipType: item.membershipType || 'member',
        name: (item?.user?.fullName && !/\bnull\b|\bundefined\b/i.test(item.user.fullName))
          ? item.user.fullName
            .replaceAll(/\bnull\b|\bundefined\b/gi, '')
            .replaceAll(/\s+/g, ' ')
            .trim()
          : (
            [item?.user?.userProfile?.firstName, item?.user?.userProfile?.lastName]
              .filter(val => val && val !== 'null' && val !== 'undefined')
              .join(' ') || 'Unknown Name'
          ),
        gender: item?.user?.userProfile?.gender || 'N/A',
        role: item.familyRole || roleMapping[item?.user?.role] || 'Member',
        contact: item?.user?.userProfile?.contactNumber,
        address: item?.user?.userProfile?.address || '',
        dob: item?.user?.userProfile?.dob || '',
        age: item?.user?.userProfile?.age || '',
        profilePic: item?.user?.profileImage,
        isAdmin: item.isFamilyAdmin ?? item?.user?.role > 1,
        // BLOCK OVERRIDE: Use new bidirectional block status payload.
        blockStatus: item.blockStatus || {
          isBlockedByMe: false,
          isBlockedByThem: false,
        },
        lastUpdated: item.updatedAt
          ? new Date(item.updatedAt).toLocaleDateString('en-IN')
          : '-',
        sourceFamilyCode: normalizeFamilyCode(item?.user?.userProfile?.familyCode || item?.familyCode),
      }));
      setFamilyMembers(members);
    } catch (err) {
      logger.error('BLOCK OVERRIDE: Failed to load family members', err);
      setFamilyMembers([]);
    } finally {
      setLoading(false);
    }
  };

  const fetchLinkedFamilies = async () => {
    if (!familyCode || !token) return;

    try {
      const res = await fetch(`${BASE_URL}/family/linked-families`, {
        headers: {
          Authorization: `Bearer ${token}`,
          Accept: 'application/json',
        },
      });

      if (!res.ok) throw new Error('Failed to load linked families');
      const data = await res.json().catch(() => []);
      const normalized = Array.isArray(data)
        ? data
          .map((entry) => ({
            familyCode: normalizeFamilyCode(entry?.familyCode),
            familyName: entry?.familyName || null,
          }))
          .filter((entry) => Boolean(entry.familyCode))
        : [];
      setLinkedFamilies(normalized);
    } catch (error) {
      logger.error('Failed to load linked families', error);
      setLinkedFamilies([]);
    }
  };

  const fetchFamilyNameByCode = async (code) => {
    try {
      const res = await fetch(`${BASE_URL}/family/code/${encodeURIComponent(code)}`, {
        headers: {
          Accept: 'application/json',
        },
      });
      if (!res.ok) return null;
      const data = await res.json().catch(() => null);
      return data?.familyName || null;
    } catch (error) {
      return null;
    }
  };

  useEffect(() => {
    if (familyCode && token) {
      setLoading(true);
      fetchMembers();
    }
  }, [familyCode, token]);

  useEffect(() => {
    if (familyCode && token) {
      fetchLinkedFamilies();
    }
  }, [familyCode, token]);

  const calculateAge = (dob) => {
    if (!dob) return 'N/A';
    const birthDate = new Date(dob);
    const today = new Date();
    let age = today.getFullYear() - birthDate.getFullYear();
    const m = today.getMonth() - birthDate.getMonth();
    if (m < 0 || (m === 0 && today.getDate() < birthDate.getDate())) age--;
    return age;
  };

  const handleViewMember = async (userId, e) => {
    e.stopPropagation();

    // Set loading state for this specific member
    setViewLoadingStates(prev => ({ ...prev, [userId]: true }));

    try {
      await onViewMember(userId);
    } finally {
      // Clear loading state after a short delay to ensure smooth transition
      setTimeout(() => {
        setViewLoadingStates(prev => ({ ...prev, [userId]: false }));
      }, 500);
    }
  };

  const handleDeleteMember = async (memberId, familyCode, userId, e) => {
    if (e?.stopPropagation) e.stopPropagation();

    if (memberIdsInTree.has(Number(userId))) {
      await Swal.fire({
        icon: 'info',
        title: 'Member is in Tree',
        text: 'This member is already placed in Family Tree. Use Family Tree unlink/delete flow to avoid genealogy breakage.',
      });
      return;
    }

    const confirm = await Swal.fire({
      icon: 'warning',
      title: 'Delete Member?',
      text: 'This will remove the member from this family.',
      showCancelButton: true,
      confirmButtonText: 'Yes, Delete',
      cancelButtonText: 'Cancel',
      confirmButtonColor: '#e53e3e',
    });

    if (!confirm.isConfirmed) return;

    try {
      const res = await fetch(
        `${BASE_URL}/family/member/delete/${memberId}/${familyCode}`,
        {
          method: 'DELETE',
          headers: {
            Authorization: `Bearer ${token}`,
            'Content-Type': 'application/json',
          },
        }
      );

      const json = await res.json().catch(() => null);

      if (!res.ok) {
        const msg = json?.message || 'Failed to delete member';
        throw new Error(msg);
      }

      await Swal.fire({
        icon: 'success',
        title: 'Member Deleted',
        text: json?.message || 'Family member removed successfully.',
      });

      setDeletedMemberIds((prev) => {
        const next = new Set(prev);
        next.add(memberId);
        return next;
      });

      setTimeout(() => {
        setFamilyMembers((prev) => prev.filter((m) => m.memberId !== memberId));
        setDeletedMemberIds((prev) => {
          const next = new Set(prev);
          next.delete(memberId);
          return next;
        });
      }, 600);
    } catch (err) {
      logger.error('BLOCK OVERRIDE: Failed to delete member', err);
      await Swal.fire({
        icon: 'error',
        title: 'Delete Failed',
        text: err?.message || 'Unable to delete this member. Please try again.',
      });
    }
  };

  const handleShareInvite = async (member, e) => {
    e.stopPropagation();

    const inviteUrl = `${window.location.origin}/edit-profile?familyCode=${familyCode}&memberId=${member.memberId}`;
    try {
      if (navigator.share) {
        await navigator.share({
          title: 'Family Tree Invitation',
          text: 'Update your family tree profile using this secure link.',
          url: inviteUrl,
        });
      } else {
        await navigator.clipboard.writeText(inviteUrl);
        await Swal.fire({
          icon: 'success',
          title: 'Invite Link Copied',
          text: 'The profile invite link has been copied to your clipboard. You can share it via WhatsApp or any app.',
        });
      }
    } catch (err) {
      logger.error('BLOCK OVERRIDE: Failed to share invite link', err);
      await Swal.fire({
        icon: 'error',
        title: 'Share Failed',
        text: 'Unable to share the invite link. Please try again.',
      });
    }
  };

  const handleMemberBlockStatusChange = (memberUserId, nextStatus) => {
    // BLOCK OVERRIDE: Apply local optimistic block status updates using new block contract.
    setFamilyMembers((prevMembers) =>
      prevMembers.map((member) =>
        Number(member.userId) === Number(memberUserId)
          ? { ...member, blockStatus: nextStatus }
          : member,
      ),
    );
  };

  const filteredMembers = useMemo(
    () =>
      familyMembers.filter((member) =>
        member.name && member.name.toLowerCase().includes(searchTerm.toLowerCase())
      ),
    [familyMembers, searchTerm],
  );

  const birthFamilyMembers = useMemo(
    () =>
      familyMembers.filter(
        (member) =>
          member.membershipType === 'member' &&
          member.name &&
          member.name.toLowerCase().includes(searchTerm.toLowerCase()),
      ),
    [familyMembers, searchTerm],
  );

  const associatedMembersAll = useMemo(
    () => familyMembers.filter((member) => member.membershipType === 'associated'),
    [familyMembers],
  );

  const linkedMembersAll = useMemo(
    () => familyMembers.filter((member) => member.membershipType === 'linked'),
    [familyMembers],
  );

  const allBirthFamilyMembers = useMemo(
    () => familyMembers.filter((member) => member.membershipType === 'member'),
    [familyMembers],
  );

  const associatedFamilyCodes = useMemo(
    () =>
      Array.from(
        new Set(
          associatedMembersAll
            .map((member) => normalizeFamilyCode(member.sourceFamilyCode))
            .filter(Boolean),
        ),
      ),
    [associatedMembersAll],
  );

  const linkedFamilyCodesFromMembers = useMemo(
    () =>
      Array.from(
        new Set(
          linkedMembersAll
            .map((member) => normalizeFamilyCode(member.sourceFamilyCode))
            .filter(Boolean),
        ),
      ),
    [linkedMembersAll],
  );

  const linkedFamiliesOptions = useMemo(() => {
    const map = new Map();
    Object.keys(treeLinkedFamilyMap || {}).forEach((code) => {
      const normalizedCode = normalizeFamilyCode(code);
      if (!normalizedCode) return;
      map.set(normalizedCode, {
        familyCode: normalizedCode,
        familyName: linkedFamilyNameMap[normalizedCode] || null,
      });
    });

    linkedFamilies.forEach((family) => {
      const code = normalizeFamilyCode(family.familyCode);
      if (!code) return;
      map.set(code, {
        familyCode: code,
        familyName: family.familyName || linkedFamilyNameMap[code] || null,
      });
    });

    linkedFamilyCodesFromMembers.forEach((code) => {
      if (!map.has(code)) {
        map.set(code, {
          familyCode: code,
          familyName: linkedFamilyNameMap[code] || null,
        });
      }
    });

    return Array.from(map.values());
  }, [linkedFamilies, linkedFamilyCodesFromMembers, treeLinkedFamilyMap, linkedFamilyNameMap]);

  const associatedFamiliesOptions = useMemo(
    () =>
      associatedFamilyCodes.map((code) => ({
        familyCode: code,
        familyName: associatedFamilyNameMap[code] || null,
      })),
    [associatedFamilyCodes, associatedFamilyNameMap],
  );

  const linkedFamilyCodesForLookup = useMemo(
    () =>
      Array.from(
        new Set([
          ...linkedFamilyCodesFromMembers,
          ...Object.keys(treeLinkedFamilyMap || {}).map((code) => normalizeFamilyCode(code)),
          ...linkedFamilies.map((entry) => normalizeFamilyCode(entry.familyCode)),
        ].filter(Boolean)),
      ),
    [linkedFamilyCodesFromMembers, treeLinkedFamilyMap, linkedFamilies],
  );

  useEffect(() => {
    let ignore = false;

    const loadAssociatedFamilyNames = async () => {
      if (!associatedFamilyCodes.length) {
        if (!ignore) {
          setAssociatedFamilyNameMap({});
        }
        return;
      }

      const entries = await Promise.all(
        associatedFamilyCodes.map(async (code) => {
          const name = await fetchFamilyNameByCode(code);
          return [code, name];
        }),
      );

      if (ignore) return;
      setAssociatedFamilyNameMap((prev) => {
        const next = { ...prev };
        entries.forEach(([code, name]) => {
          next[code] = name || prev[code] || null;
        });
        return next;
      });
    };

    loadAssociatedFamilyNames();
    return () => {
      ignore = true;
    };
  }, [associatedFamilyCodes]);

  useEffect(() => {
    let ignore = false;

    const loadLinkedFamilyNames = async () => {
      if (!linkedFamilyCodesForLookup.length) {
        if (!ignore) {
          setLinkedFamilyNameMap({});
        }
        return;
      }

      const entries = await Promise.all(
        linkedFamilyCodesForLookup.map(async (code) => {
          const fromLinkedEndpoint = linkedFamilies.find(
            (entry) => normalizeFamilyCode(entry.familyCode) === code,
          )?.familyName;
          if (fromLinkedEndpoint) return [code, fromLinkedEndpoint];

          const name = await fetchFamilyNameByCode(code);
          return [code, name];
        }),
      );

      if (ignore) return;
      setLinkedFamilyNameMap((prev) => {
        const next = { ...prev };
        entries.forEach(([code, name]) => {
          next[code] = name || prev[code] || null;
        });
        return next;
      });
    };

    loadLinkedFamilyNames();
    return () => {
      ignore = true;
    };
  }, [linkedFamilyCodesForLookup, linkedFamilies]);

  useEffect(() => {
    if (!associatedFamiliesOptions.length) {
      setSelectedAssociatedFamilyCode('');
      return;
    }

    if (
      !selectedAssociatedFamilyCode ||
      !associatedFamiliesOptions.some((entry) => entry.familyCode === selectedAssociatedFamilyCode)
    ) {
      setSelectedAssociatedFamilyCode(associatedFamiliesOptions[0].familyCode);
    }
  }, [associatedFamiliesOptions, selectedAssociatedFamilyCode]);

  useEffect(() => {
    if (!linkedFamiliesOptions.length) {
      setSelectedLinkedFamilyCode('');
      return;
    }

    if (
      !selectedLinkedFamilyCode ||
      !linkedFamiliesOptions.some((entry) => entry.familyCode === selectedLinkedFamilyCode)
    ) {
      setSelectedLinkedFamilyCode(linkedFamiliesOptions[0].familyCode);
    }
  }, [linkedFamiliesOptions, selectedLinkedFamilyCode]);

  const selectedAssociatedFamilyMembers = useMemo(() => {
    if (!selectedAssociatedFamilyCode) return [];
    return associatedMembersAll.filter(
      (member) =>
        normalizeFamilyCode(member.sourceFamilyCode) === selectedAssociatedFamilyCode &&
        member.name &&
        member.name.toLowerCase().includes(searchTerm.toLowerCase()),
    );
  }, [associatedMembersAll, selectedAssociatedFamilyCode, searchTerm]);

  const selectedLinkedFamilyMembers = useMemo(() => {
    if (!selectedLinkedFamilyCode) return [];
    const fromMemberList = linkedMembersAll.filter(
      (member) =>
        normalizeFamilyCode(member.sourceFamilyCode) === selectedLinkedFamilyCode &&
        member.name &&
        member.name.toLowerCase().includes(searchTerm.toLowerCase()),
    );

    if (fromMemberList.length > 0) {
      return fromMemberList;
    }

    const fromTree = Array.isArray(treeLinkedFamilyMap?.[selectedLinkedFamilyCode])
      ? treeLinkedFamilyMap[selectedLinkedFamilyCode]
      : [];

    return fromTree.filter(
      (member) =>
        member.name &&
        member.name.toLowerCase().includes(searchTerm.toLowerCase()),
    );
  }, [linkedMembersAll, selectedLinkedFamilyCode, treeLinkedFamilyMap, searchTerm]);

  useEffect(() => {
    let ignore = false;

    const loadMembersNotInTree = async () => {
      if (!familyCode || !token) {
        setMembersNotInTree([]);
        setMemberIdsInTree(new Set());
        setTreeLinkedFamilyMap({});
        return;
      }

      setNotInTreeLoading(true);
      try {
        const res = await fetch(`${BASE_URL}/family/tree/${familyCode}`, {
          headers: {
            Authorization: `Bearer ${token}`,
            Accept: 'application/json',
          },
        });
        if (!res.ok) throw new Error('Failed to fetch family tree');

        const json = await res.json().catch(() => null);
        const people = Array.isArray(json?.people)
          ? json.people
          : Array.isArray(json?.data?.people)
            ? json.data.people
            : [];

        const idsInTree = new Set(
          people
            .map((person) => Number(person?.userId || person?.memberId))
            .filter((id) => Number.isFinite(id) && id > 0),
        );

        const linkedFromTree = {};
        people
          .filter((person) => Boolean(person?.isExternalLinked))
          .forEach((person, index) => {
            const linkedCode = normalizeFamilyCode(person?.canonicalFamilyCode);
            if (!linkedCode) return;
            if (!linkedFromTree[linkedCode]) linkedFromTree[linkedCode] = [];

            linkedFromTree[linkedCode].push({
              id: `tree-linked-${linkedCode}-${index}`,
              memberId: Number(person?.memberId) || null,
              userId: Number(person?.userId || person?.memberId) || null,
              membershipType: 'linked',
              name: person?.name || 'Unknown',
              gender: person?.gender || 'N/A',
              role: 'Member',
              contact: person?.contactNumber || person?.mobile || '',
              address: '',
              dob: '',
              age: person?.age || '',
              profilePic: person?.img || null,
              isAdmin: false,
              blockStatus: person?.blockStatus || {
                isBlockedByMe: false,
                isBlockedByThem: false,
              },
              lastUpdated: '-',
              sourceFamilyCode: linkedCode,
            });
          });

        const notInTreeMembers = allBirthFamilyMembers.filter(
          (member) => !idsInTree.has(Number(member.userId)),
        );

        if (!ignore) {
          setMemberIdsInTree(idsInTree);
          setTreeLinkedFamilyMap(linkedFromTree);
          setMembersNotInTree(notInTreeMembers);
        }
      } catch (error) {
        logger.error('Failed to compute members not in tree', error);
        if (!ignore) {
          setMemberIdsInTree(new Set());
          setTreeLinkedFamilyMap({});
          setMembersNotInTree([]);
        }
      } finally {
        if (!ignore) {
          setNotInTreeLoading(false);
        }
      }
    };

    loadMembersNotInTree();
    return () => {
      ignore = true;
    };
  }, [familyCode, token, allBirthFamilyMembers]);

  const filteredMembersNotInTree = useMemo(
    () =>
      membersNotInTree.filter((member) =>
        member.name && member.name.toLowerCase().includes(searchTerm.toLowerCase())
      ),
    [membersNotInTree, searchTerm],
  );

  const privacyFamilyOptions = useMemo(() => {
    const map = new Map();
    if (birthFamilyCode) {
      map.set(birthFamilyCode, {
        familyCode: birthFamilyCode,
        familyName: 'Birth Family',
      });
    }

    associatedFamiliesOptions.forEach((entry) => {
      map.set(entry.familyCode, {
        familyCode: entry.familyCode,
        familyName: entry.familyName || 'Associated Family',
      });
    });

    linkedFamiliesOptions.forEach((entry) => {
      map.set(entry.familyCode, {
        familyCode: entry.familyCode,
        familyName: entry.familyName || 'Linked Family',
      });
    });

    return Array.from(map.values());
  }, [birthFamilyCode, associatedFamiliesOptions, linkedFamiliesOptions]);

  useEffect(() => {
    const userId = currentUser?.userId;
    const defaults = buildDefaultFamilyPrivacySettings(birthFamilyCode);
    const stored = getFamilyPrivacySettings({ userId, familyCode: birthFamilyCode });
    const validCodes = new Set(privacyFamilyOptions.map((entry) => entry.familyCode));

    const normalizeContentSetting = (setting, fallbackSetting) => {
      const visibility =
        setting?.visibility === 'specific-family' ? 'specific-family' : 'all-members';
      const requestedCode = normalizeFamilyCode(setting?.familyCode || fallbackSetting?.familyCode);
      const resolvedCode = validCodes.has(requestedCode)
        ? requestedCode
        : fallbackSetting?.familyCode || birthFamilyCode;
      return {
        visibility,
        familyCode: resolvedCode,
      };
    };

    const next = {
      ...defaults,
      posts: normalizeContentSetting(stored?.posts, defaults.posts),
      albums: normalizeContentSetting(stored?.albums, defaults.albums),
      events: normalizeContentSetting(stored?.events, defaults.events),
      updatedAt: stored?.updatedAt || '',
    };

    setPrivacySettings(next);
    setPrivacySavedAt(stored?.updatedAt || '');
  }, [currentUser?.userId, birthFamilyCode, privacyFamilyOptions]);

  const updatePrivacySetting = (contentType, key, value) => {
    setPrivacySettings((prev) => ({
      ...prev,
      [contentType]: {
        ...prev[contentType],
        [key]: value,
      },
    }));
  };

  const handleSavePrivacySettings = async () => {
    const userId = currentUser?.userId;
    if (!userId) return;

    const saved = saveFamilyPrivacySettings({
      userId,
      settings: privacySettings,
    });
    setPrivacySettings(saved);
    setPrivacySavedAt(saved?.updatedAt || '');

    window.dispatchEvent(
      new CustomEvent('family-privacy-settings-updated', {
        detail: { userId, settings: saved },
      }),
    );

    await Swal.fire({
      icon: 'success',
      title: 'Privacy Saved',
      text: 'Your content privacy settings have been updated.',
      timer: 1400,
      showConfirmButton: false,
    });
  };

  // BLOCK OVERRIDE: Keep blocked users out of active grid and move them to blocked section only.
  const activeBirthMembers = birthFamilyMembers.filter(
    (member) => !member?.blockStatus?.isBlockedByMe,
  );
  const blockedMembers = filteredMembers.filter(
    (member) => member?.blockStatus?.isBlockedByMe,
  );

  const SingleMemberCard = ({
    member,
    showFamilyCode = false,
    allowManageActions = false,
    allowDelete = false,
  }) => (
    <div
      onClick={() => {
        // Only allow viewing if user has Admin (role 2) or Superadmin (role 3) role
        if (
          !deletedMemberIds.has(member.memberId) &&
          currentUserIsFamilyAdmin &&
          !member?.blockStatus?.isBlockedByMe
        ) {
          handleViewMember(member.userId, { stopPropagation: () => { } });
        }
      }}
      className={`relative bg-white rounded-2xl border border-gray-100 overflow-hidden shadow-md transition-all duration-300 ease-in-out group transform hover:-translate-y-1 ${currentUserIsFamilyAdmin
          ? 'hover:shadow-lg cursor-pointer'
          : 'cursor-default'
        } ${deletedMemberIds.has(member.memberId) ? 'opacity-20 grayscale pointer-events-none' : ''}`}
    >
      <div className="flex items-start p-5 pb-0">
        <div className="relative flex-shrink-0 w-24 h-24 rounded-full overflow-hidden border-3 border-primary-200 shadow-lg">
          <img
            src={member.profilePic || 'https://placehold.co/96x96/e2e8f0/64748b?text=ðŸ‘¤'}
            alt={member.name}
            className="w-full h-full object-cover"
            onError={(e) => {
              e.target.src = 'https://placehold.co/96x96/e2e8f0/64748b?text=ðŸ‘¤';
            }}
          />
          {/* {member.isAdmin && (
            <span className="absolute bottom-0 right-0 -mr-1 -mb-1 px-2 py-0.5 bg-primary-DEFAULT text-white text-xs font-bold rounded-full border-2 border-white shadow">
              Admin
            </span>
          )} */}
        </div>

        <div className="ml-4 flex-1 min-w-0">
          <div className="flex items-center space-x-2">
            <h3 className="text-xl font-extrabold text-gray-900 truncate pr-2">{member.name}</h3>
            {currentUserIsFamilyAdmin && member?.blockStatus?.isBlockedByMe && (
              <BlockedBadge />
            )}
            {member.membershipType !== 'member' && (
              <span className="inline-block text-xs font-semibold px-2 py-0.5 rounded-full bg-gray-100 text-gray-700">
                Linked
              </span>
            )}
          </div>
          <span
            className={`mt-1 inline-block text-sm font-semibold px-3 py-1 rounded-full ${relationColors[member.role] || 'bg-gray-100 text-gray-800'
              }`}
          >
            {member.role}
          </span>
          <div className="mt-2 flex items-center text-sm text-gray-600">
            <FaBirthdayCake className="mr-2 text-primary-500" size={16} />
            <span className="font-medium">{member.age || calculateAge(member.dob)} years old</span>
          </div>
          <div className="mt-1 flex items-center text-sm text-gray-600">
            {member.gender === 'male' ? (
              <FaMale className="mr-2 text-blue-500" size={16} />
            ) : (
              <FaFemale className="mr-2 text-pink-500" size={16} />
            )}
            <span className="font-medium">{member.gender}</span>
          </div>
        </div>
      </div>

      {showFamilyCode && member.sourceFamilyCode && (
        <div className="px-5 pt-3">
          <span className="inline-flex rounded-full bg-slate-100 px-3 py-1 text-xs font-semibold text-slate-700">
            Family Code: {member.sourceFamilyCode}
          </span>
        </div>
      )}

      <div className="px-5 py-4 mt-4 bg-gray-50 border-t border-b border-gray-100 mx-5 rounded-lg">
        {member.contact && (
          <div className="flex items-center text-sm text-gray-700 mb-2">
            <FaPhone className="mr-3 text-primary-500" size={16} />
            <span className="font-medium">{member.contact}</span>
          </div>
        )}
        {member.address && (
          <div className="flex items-start text-sm text-gray-700">
            <FaHome className="mr-3 text-primary-500 mt-1" size={16} />
            <span className="line-clamp-2">{member.address}</span>
          </div>
        )}
      </div>

      <div className="flex justify-between items-center px-5 py-4">
        <span className="text-xs text-gray-500">Last updated: {member.lastUpdated}</span>
        <div className="flex space-x-2">
          {/* Show view, edit, delete buttons only for Admin (role 2) and Superadmin (role 3) */}
          {currentUserIsFamilyAdmin && (
            <>
              {/* Share profile invite link */}
              {allowManageActions && member.membershipType === 'member' && (
                <button
                  onClick={(e) => handleShareInvite(member, e)}
                  disabled={deletedMemberIds.has(member.memberId)}
                  className="p-2 rounded-full bg-gray-100 text-gray-600 hover:bg-blue-100 hover:text-blue-700 transition-colors tooltip"
                  title="Share profile invite link"
                >
                  <FiShare2 size={18} />
                </button>
              )}

              {/* BLOCK OVERRIDE: Legacy family-member block buttons replaced by user-level BlockButton. */}
              {allowManageActions && member.membershipType === 'member' && currentUser?.userId !== member.userId && (
                <BlockButton
                  userId={member.userId}
                  isBlockedByMe={Boolean(member?.blockStatus?.isBlockedByMe)}
                  location="membersList"
                  userName={member.name}
                  onStatusChange={(nextStatus) => handleMemberBlockStatusChange(member.userId, nextStatus)}
                />
              )}

              {allowDelete && member.membershipType === 'member' && currentUser?.userId !== member.userId && (
                <button
                  onClick={(e) => {
                    e.stopPropagation();
                    handleDeleteMember(member.memberId, familyCode, member.userId, e);
                  }}
                  disabled={deletedMemberIds.has(member.memberId)}
                  className="p-2 rounded-full bg-gray-100 text-gray-600 hover:bg-red-100 hover:text-red-700 transition-colors tooltip"
                  title="Delete Member"
                >
                  <FiTrash2 size={18} />
                </button>
              )}
              {/* View button with loading state */}
              <button
                onClick={(e) => handleViewMember(member.userId, e)}
                disabled={deletedMemberIds.has(member.memberId) || viewLoadingStates[member.userId]}
                className={`p-2 rounded-full transition-all duration-200 tooltip ${viewLoadingStates[member.userId]
                    ? 'bg-primary-100 text-primary-700 cursor-not-allowed'
                    : 'bg-gray-100 text-gray-600 hover:bg-primary-100 hover:text-primary-700'
                  }`}
                title="View Member"
              >
                {viewLoadingStates[member.userId] ? (
                  <FiLoader size={18} className="animate-spin" />
                ) : (
                  <FiEye size={18} />
                )}
              </button>
            </>
          )}
        </div>
      </div>
    </div>
  );

  const PrivacyControls = () => (
    <section className="rounded-2xl border border-indigo-200 bg-indigo-50/70 p-4 sm:p-5">
      <div className="flex flex-col gap-2 sm:flex-row sm:items-center sm:justify-between">
        <div>
          <h2 className="text-lg font-semibold text-indigo-900">Privacy Settings</h2>
          <p className="text-sm text-indigo-800">
            Configure visibility for posts, albums, and events at family level. Default is All Members (except blocked users).
          </p>
        </div>
        <button
          type="button"
          onClick={handleSavePrivacySettings}
          className="rounded-lg bg-indigo-600 px-4 py-2 text-sm font-semibold text-white hover:bg-indigo-700"
        >
          Save Privacy Settings
        </button>
      </div>

      <div className="mt-4 grid grid-cols-1 gap-3 md:grid-cols-3">
        {[
          { key: 'posts', label: 'Posts' },
          { key: 'albums', label: 'Albums' },
          { key: 'events', label: 'Events' },
        ].map((entry) => (
          <div key={entry.key} className="rounded-xl border border-indigo-200 bg-white p-3">
            <p className="text-sm font-semibold text-gray-900">{entry.label}</p>

            <label className="mt-2 block text-xs font-medium text-gray-600">Visibility</label>
            <select
              value={privacySettings?.[entry.key]?.visibility || 'all-members'}
              onChange={(e) => updatePrivacySetting(entry.key, 'visibility', e.target.value)}
              className="mt-1 w-full rounded-md border border-gray-300 px-3 py-2 text-sm focus:border-indigo-500 focus:outline-none focus:ring-2 focus:ring-indigo-200"
            >
              {PRIVACY_VISIBILITY_OPTIONS.map((option) => (
                <option key={option.value} value={option.value}>
                  {option.label}
                </option>
              ))}
            </select>

            <label className="mt-3 block text-xs font-medium text-gray-600">Family Level</label>
            <select
              value={privacySettings?.[entry.key]?.familyCode || birthFamilyCode}
              onChange={(e) => updatePrivacySetting(entry.key, 'familyCode', normalizeFamilyCode(e.target.value))}
              className="mt-1 w-full rounded-md border border-gray-300 px-3 py-2 text-sm focus:border-indigo-500 focus:outline-none focus:ring-2 focus:ring-indigo-200"
              disabled={privacySettings?.[entry.key]?.visibility !== 'specific-family'}
            >
              {privacyFamilyOptions.map((familyOption) => (
                <option key={`${entry.key}-${familyOption.familyCode}`} value={familyOption.familyCode}>
                  {(familyOption.familyName || 'Family')} ({familyOption.familyCode})
                </option>
              ))}
            </select>
          </div>
        ))}
      </div>

      {privacySavedAt && (
        <p className="mt-3 text-xs text-indigo-700">
          Saved on this device: {new Date(privacySavedAt).toLocaleString()}
        </p>
      )}
    </section>
  );

  const TABS = [
    { id: 'birth', label: 'Birth Family', count: activeBirthMembers.length, color: 'text-slate-700 bg-slate-100' },
    { id: 'associated', label: 'Associated Families', count: associatedFamiliesOptions.length, color: 'text-sky-700 bg-sky-100' },
    { id: 'linked', label: 'Linked Families', count: linkedFamiliesOptions.length, color: 'text-emerald-700 bg-emerald-100' },
    { id: 'pending', label: 'Members Not In Tree', count: filteredMembersNotInTree.length, color: 'text-amber-700 bg-amber-100' },
    { id: 'blocked', label: 'Blocked Members', count: blockedMembers.length, color: 'text-red-700 bg-red-100' },
    { id: 'privacy', label: 'Privacy Settings', count: null, color: null },
  ];

  return (
    <div className="space-y-6">
      {/* Search Input */}
      <div className="bg-white p-2 rounded-xl border border-gray-200 shadow-sm">
        <input
          type="text"
          placeholder="Search family members..."
          value={searchTerm}
          onChange={(e) => setSearchTerm(e.target.value)}
          className="w-full p-3 bg-transparent border-none focus:outline-none focus:ring-0 text-gray-800 placeholder-gray-400"
        />
      </div>

      {/* Tab Navigation Hub */}
      <div className="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden mt-6">
        <div className="flex overflow-x-auto hide-scrollbar border-b border-gray-100">
          {TABS.map((tab) => (
            <button
              key={tab.id}
              onClick={() => setActiveTab(tab.id)}
              className={`flex-shrink-0 flex items-center gap-2 px-6 py-4 text-sm font-semibold transition-all duration-200 relative ${
                activeTab === tab.id
                  ? 'text-primary-600 bg-primary-50/50'
                  : 'text-gray-600 hover:text-gray-900 hover:bg-gray-50'
              }`}
            >
              {tab.label}
              {tab.count !== null && (
                <span className={`px-2 py-0.5 rounded-full text-xs ${activeTab === tab.id ? 'bg-primary-100 text-primary-700' : 'bg-gray-100 text-gray-600'}`}>
                  {tab.count}
                </span>
              )}
              {activeTab === tab.id && (
                <div className="absolute bottom-0 left-0 right-0 h-0.5 bg-primary-600" />
              )}
            </button>
          ))}
        </div>
      </div>

      {loading ? (
        <div className="flex justify-center items-center py-20">
          <div className="animate-spin rounded-full h-10 w-10 border-t-4 border-primary-600 border-solid" />
        </div>
      ) : (
        <div className="animate-in fade-in duration-300">
          {!filteredMembers.length && !notInTreeLoading && activeTab !== 'privacy' && (
            <div className="bg-white rounded-xl border border-gray-200 p-8 text-center text-gray-500 shadow-sm">
              <p>No family members found.</p>
            </div>
          )}

          {activeTab === 'birth' && (
            <section className="rounded-xl border border-slate-200 bg-white p-4 sm:p-5 shadow-sm">
              <div className="mb-6">
                <h2 className="text-xl font-bold text-slate-900">Birth Family</h2>
                <p className="text-sm text-slate-500 mt-1">Manage members of your primary birth family.</p>
              </div>

              {activeBirthMembers.length > 0 ? (
                <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
                  {activeBirthMembers.map((member) => (
                    <SingleMemberCard key={`birth-${member.id}`} member={member} allowManageActions />
                  ))}
                </div>
              ) : (
                <div className="text-center py-10 bg-slate-50 rounded-lg border border-dashed border-slate-300">
                  <p className="text-sm text-slate-500">No birth family members found.</p>
                </div>
              )}
            </section>
          )}

          {activeTab === 'associated' && (
            <section className="rounded-xl border border-sky-200 bg-sky-50 p-4 sm:p-5 shadow-sm">
              <div className="mb-6 flex flex-wrap items-center justify-between gap-4">
                <div>
                  <h2 className="text-xl font-bold text-sky-900">Associated Families</h2>
                  <p className="text-sm text-sky-700 mt-1">Members linked through marriage or other primary associations.</p>
                </div>
              </div>

              {associatedFamiliesOptions.length > 0 ? (
                <>
                  <div className="mb-6 flex flex-wrap gap-2 bg-white/50 p-2 rounded-lg inline-flex border border-sky-100 overflow-x-auto hide-scrollbar shadow-sm">
                    {associatedFamiliesOptions.map((family) => (
                      <button
                        type="button"
                        key={`associated-family-${family.familyCode}`}
                        onClick={() => setSelectedAssociatedFamilyCode(family.familyCode)}
                        className={`rounded-md px-4 py-2 text-sm font-semibold transition whitespace-nowrap ${
                          selectedAssociatedFamilyCode === family.familyCode
                            ? 'bg-sky-600 text-white shadow-md'
                            : 'bg-white text-sky-700 hover:bg-sky-100'
                        }`}
                      >
                        {(family.familyName || 'Family')} ({family.familyCode})
                      </button>
                    ))}
                  </div>

                  {selectedAssociatedFamilyMembers.length > 0 ? (
                    <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
                      {selectedAssociatedFamilyMembers.map((member) => (
                        <SingleMemberCard
                          key={`associated-${member.id}`}
                          member={member}
                          showFamilyCode
                        />
                      ))}
                    </div>
                  ) : (
                    <div className="text-center py-10 bg-white rounded-lg border border-dashed border-sky-200">
                      <p className="text-sm text-sky-600">No members found for this associated family matching your search.</p>
                    </div>
                  )}
                </>
              ) : (
                <div className="text-center py-10 bg-white rounded-lg border border-dashed border-sky-200">
                  <p className="text-sm text-sky-600">No associated families linked to your profile yet.</p>
                </div>
              )}
            </section>
          )}

          {activeTab === 'linked' && (
            <section className="rounded-xl border border-emerald-200 bg-emerald-50 p-4 sm:p-5 shadow-sm">
              <div className="mb-6 flex flex-wrap items-center justify-between gap-4">
                <div>
                  <h2 className="text-xl font-bold text-emerald-900">Linked Families</h2>
                  <p className="text-sm text-emerald-700 mt-1">Families connected through member profile linking.</p>
                </div>
              </div>

              {linkedFamiliesOptions.length > 0 ? (
                <>
                  <div className="mb-6 flex flex-wrap gap-2 bg-white/50 p-2 rounded-lg inline-flex border border-emerald-100 overflow-x-auto hide-scrollbar shadow-sm">
                    {linkedFamiliesOptions.map((family) => (
                      <button
                        type="button"
                        key={`linked-family-${family.familyCode}`}
                        onClick={() => setSelectedLinkedFamilyCode(family.familyCode)}
                        className={`rounded-md px-4 py-2 text-sm font-semibold transition whitespace-nowrap ${
                          selectedLinkedFamilyCode === family.familyCode
                            ? 'bg-emerald-600 text-white shadow-md'
                            : 'bg-white text-emerald-700 hover:bg-emerald-100'
                        }`}
                      >
                        {(family.familyName || 'Family')} ({family.familyCode})
                      </button>
                    ))}
                  </div>

                  {selectedLinkedFamilyMembers.length > 0 ? (
                    <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
                      {selectedLinkedFamilyMembers.map((member) => (
                        <SingleMemberCard
                          key={`linked-${member.id}`}
                          member={member}
                          showFamilyCode
                        />
                      ))}
                    </div>
                  ) : (
                    <div className="text-center py-10 bg-white rounded-lg border border-dashed border-emerald-200">
                      <p className="text-sm text-emerald-600">No members found for this linked family matching your search.</p>
                    </div>
                  )}
                </>
              ) : (
                <div className="text-center py-10 bg-white rounded-lg border border-dashed border-emerald-200">
                  <p className="text-sm text-emerald-600">No linked families discovered yet.</p>
                </div>
              )}
            </section>
          )}

          {activeTab === 'pending' && (
            <section className="rounded-xl border border-amber-200 bg-amber-50 p-4 sm:p-5 shadow-sm">
              <div className="mb-6">
                <h2 className="text-xl font-bold text-amber-900">Pending Placement</h2>
                <p className="text-sm text-amber-800 mt-1">
                  Members that have joined your family through the invite link but have not been placed on the tree canvas by an Admin.
                </p>
              </div>

              {notInTreeLoading ? (
                <div className="flex items-center justify-center py-12">
                  <FiLoader className="animate-spin text-amber-600" size={30} />
                </div>
              ) : filteredMembersNotInTree.length > 0 ? (
                <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
                  {filteredMembersNotInTree.map((member) => (
                    <SingleMemberCard
                      key={`not-in-tree-${member.id}`}
                      member={member}
                      allowDelete
                    />
                  ))}
                </div>
              ) : (
                <div className="text-center py-10 bg-white rounded-lg border border-dashed border-amber-200">
                  <p className="text-sm text-amber-700">All registered members have been successfully placed on your tree!</p>
                </div>
              )}
            </section>
          )}

          {activeTab === 'blocked' && (
            <section className="rounded-xl border border-red-200 bg-red-50 p-4 sm:p-5 shadow-sm">
              <div className="mb-6">
                <h2 className="text-xl font-bold text-red-900">Blocked Profiles</h2>
                <p className="text-sm text-red-800 mt-1">Users you have restricted from viewing your updates or interacting with you.</p>
              </div>

              {blockedMembers.length > 0 ? (
                <div className="mt-4 grid grid-cols-1 gap-4 sm:grid-cols-2 lg:grid-cols-3">
                  {blockedMembers.map((member) => (
                    <div
                      key={`blocked-member-${member.id}`}
                      className="flex flex-col sm:flex-row items-center justify-between gap-4 rounded-xl border border-red-200 bg-white p-4 shadow-sm"
                    >
                      <div className="flex min-w-0 items-center justify-center sm:justify-start gap-4 w-full sm:w-auto text-center sm:text-left">
                        <img
                          src={member.profilePic || 'https://placehold.co/48x48/e2e8f0/64748b?text=ðŸ‘¤'}
                          alt={member.name}
                          className="h-14 w-14 flex-shrink-0 rounded-full object-cover ring-4 ring-red-50"
                        />

                        <div className="min-w-0">
                          <div className="flex flex-col sm:flex-row items-center sm:gap-2">
                            <span className="truncate text-base font-bold text-gray-900">{member.name}</span>
                            <div className="mt-1 sm:mt-0"><BlockedBadge /></div>
                          </div>
                          <div className="mt-2 flex flex-wrap justify-center sm:justify-start gap-2">
                            <span className={`inline-flex items-center rounded-full px-2 py-0.5 text-xs font-semibold ${relationColors[member.role] || 'bg-gray-100 text-gray-800'}`}>
                              {member.role}
                            </span>
                            {member.sourceFamilyCode && (
                              <span className="inline-flex items-center rounded-full bg-slate-100 px-2 py-0.5 text-xs font-semibold text-slate-700">
                                {member.sourceFamilyCode}
                              </span>
                            )}
                          </div>
                        </div>
                      </div>

                      {currentUserIsFamilyAdmin && (
                        <div className="flex flex-shrink-0 items-center w-full sm:w-auto justify-center">
                          <BlockButton
                            userId={member.userId}
                            isBlockedByMe
                            location="profile"
                            userName={member.name}
                            onStatusChange={(nextStatus) =>
                              handleMemberBlockStatusChange(member.userId, nextStatus)
                            }
                          />
                        </div>
                      )}
                    </div>
                  ))}
                </div>
              ) : (
                <div className="text-center py-10 bg-white rounded-lg border border-dashed border-red-200">
                  <p className="text-sm text-red-600">You haven't blocked any family members.</p>
                </div>
              )}
            </section>
          )}

          {activeTab === 'privacy' && (
            <div className="animate-in slide-in-from-bottom-4 duration-300">
              <PrivacyControls />
            </div>
          )}
        </div>
      )}
    </div>
  );
};

export default FamilyMemberCard;
